<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
      body { background-color: #f0f2f5; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
      .card { border: none; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
      .header-bg { background: linear-gradient(135deg, #0d6efd 0%, #0043a8 100%); color: white; border-radius: 12px 12px 0 0 !important; }
      .btn-primary { background-color: #0d6efd; border: none; padding: 10px; font-weight: 500; }
      .table-hover tbody tr:hover { background-color: #f8f9fa; }
      .loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 9999; justify-content: center; align-items: center; }
    </style>
  </head>
  <body>

    <div id="loading" class="loading-overlay">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Cargando...</span>
      </div>
    </div>

    <div class="container py-5">
      <h2 class="text-center mb-4 fw-bold text-secondary">Sistema de Asignaci√≥n de Salones</h2>
      
      <div class="row g-4">
        
        <div class="col-lg-4">
          <div class="card h-100">
            <div class="card-header header-bg p-3">
              <h5 class="mb-0 text-center">üìÖ Nueva Asignaci√≥n</h5>
            </div>
            <div class="card-body p-4">
              <form id="asignacionForm" onsubmit="handleFormSubmit(this)">
                
                <div class="mb-3">
                  <label class="form-label fw-bold small text-muted">DOCENTE</label>
                  <input type="text" class="form-control" name="docente" required placeholder="Ej. Juan P√©rez">
                </div>

                <div class="mb-3">
                  <label class="form-label fw-bold small text-muted">MATERIA</label>
                  <input type="text" class="form-control" name="materia" required placeholder="Ej. Matem√°ticas I">
                </div>

                <div class="mb-3">
                  <label class="form-label fw-bold small text-muted">SAL√ìN</label>
                  <select class="form-select" id="salonSelect" name="salon" required>
                    <option selected disabled value="">Cargando salones...</option>
                  </select>
                </div>

                <div class="row">
                  <div class="col-6 mb-3">
                    <label class="form-label fw-bold small text-muted">HORA INICIO</label>
                    <select class="form-select time-select" name="horaInicio" required>
                       <option selected disabled value="">...</option>
                    </select>
                  </div>
                  <div class="col-6 mb-3">
                    <label class="form-label fw-bold small text-muted">HORA FIN</label>
                    <select class="form-select time-select" name="horaFin" required>
                       <option selected disabled value="">...</option>
                    </select>
                  </div>
                </div>

                <div class="d-grid mt-2">
                  <button type="submit" class="btn btn-primary shadow-sm" id="btnGuardar">
                    Confirmar Asignaci√≥n
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>

        <div class="col-lg-8">
          <div class="card h-100">
            <div class="card-header bg-white border-bottom p-3 d-flex justify-content-between align-items-center">
              <h5 class="mb-0 text-dark">üìã Asignaciones Recientes</h5>
              <button class="btn btn-sm btn-outline-secondary" onclick="loadTable()">Actualizar</button>
            </div>
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-hover mb-0 align-middle">
                  <thead class="table-light">
                    <tr>
                      <th class="ps-4">Horario</th>
                      <th>Sal√≥n</th>
                      <th>Docente</th>
                      <th>Materia</th>
                    </tr>
                  </thead>
                  <tbody id="tablaCuerpo">
                    <tr><td colspan="4" class="text-center py-5 text-muted">Cargando registros...</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>

    <script>
      // Inicializaci√≥n al cargar la p√°gina
      window.onload = function() {
        showLoading(true);
        loadOptions(); // Carga salones y horarios desde el Sheet
        loadTable();   // Carga la tabla de asignaciones
      };

      // 1. Cargar Opciones (Selects)
      function loadOptions() {
        google.script.run.withSuccessHandler(function(data) {
          const salonSelect = document.getElementById('salonSelect');
          const timeSelects = document.querySelectorAll('.time-select');

          // Llenar Salones
          salonSelect.innerHTML = '<option selected disabled value="">Selecciona sal√≥n</option>';
          if(data.salones.length > 0) {
            data.salones.forEach(s => {
              salonSelect.innerHTML += `<option value="${s}">${s}</option>`;
            });
          } else {
             salonSelect.innerHTML += `<option disabled>No hay salones en hoja Config</option>`;
          }

          // Llenar Horarios (en ambos selects)
          timeSelects.forEach(select => {
            select.innerHTML = '<option selected disabled value="">Hora</option>';
            data.horarios.forEach(h => {
               // Convertir a string limpio por si viene como fecha completa
               let timeStr = h.toString(); 
               if(h instanceof Date || (typeof h === 'string' && h.includes('T'))) {
                 // Intento b√°sico de formateo si es objeto Date
                 let dateObj = new Date(h);
                 if(!isNaN(dateObj)) {
                    timeStr = dateObj.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                 }
               }
               // Limpiar GMT si aparece en texto
               timeStr = timeStr.replace(/GMT.*$/, '').trim();
               select.innerHTML += `<option value="${timeStr}">${timeStr}</option>`;
            });
          });
          
          checkLoadingComplete();

        }).withFailureHandler(handleError).getOptions();
      }

      // 2. Manejar Env√≠o de Formulario
      function handleFormSubmit(formObject) {
        event.preventDefault(); // Evita recarga
        
        const btn = document.getElementById('btnGuardar');
        const originalText = btn.innerHTML;
        
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Guardando...';

        google.script.run.withSuccessHandler(function(updatedData) {
          // Resetear formulario
          document.getElementById('asignacionForm').reset();
          
          // Restaurar bot√≥n
          btn.disabled = false;
          btn.innerHTML = originalText;
          
          // Actualizar tabla
          updateTableDOM(updatedData);
          
          // Feedback visual simple
          alert("‚úÖ Asignaci√≥n guardada correctamente.");

        }).withFailureHandler(function(e){
           alert("Error al guardar: " + e.message);
           btn.disabled = false;
           btn.innerHTML = originalText;
        }).saveAssignment(formObject);
      }

      // 3. Cargar Tabla
      function loadTable() {
        google.script.run.withSuccessHandler(function(data){
          updateTableDOM(data);
          checkLoadingComplete();
        }).withFailureHandler(handleError).getAssignments();
      }

      // 4. Renderizar Tabla
      function updateTableDOM(data) {
        const tbody = document.getElementById('tablaCuerpo');
        tbody.innerHTML = "";

        if (!data || data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-muted">No hay asignaciones registradas a√∫n.</td></tr>';
          return;
        }

        data.forEach(row => {
          // row[1]=Inicio, row[2]=Fin, row[3]=Salon, row[4]=Docente, row[5]=Materia
          let horaInicio = formatTimeView(row[1]);
          let horaFin = formatTimeView(row[2]);

          tbody.innerHTML += `
            <tr>
              <td class="ps-4 fw-bold text-dark">${horaInicio} - ${horaFin}</td>
              <td><span class="badge bg-primary rounded-pill">${row[3]}</span></td>
              <td class="text-secondary">${row[4]}</td>
              <td class="text-secondary">${row[5]}</td>
            </tr>
          `;
        });
      }

      // Utils
      function formatTimeView(val){
         if(!val) return "--:--";
         // Si viene como objeto fecha string largo, cortamos
         let str = val.toString();
         if(str.match(/[0-9]{2}:[0-9]{2}/)) {
            // Intenta extraer HH:MM
            let match = str.match(/([0-9]{1,2}:[0-9]{2})/);
            return match ? match[0] : str;
         }
         return str;
      }

      function handleError(e) {
        console.error(e);
        alert("Ocurri√≥ un error: " + e.message);
        showLoading(false);
      }

      // Control simple de carga inicial (esperamos 2 llamadas: options y table)
      let initialLoads = 0;
      function checkLoadingComplete(){
        initialLoads++;
        if(initialLoads >= 2) showLoading(false);
      }

      function showLoading(show) {
        document.getElementById('loading').style.display = show ? 'flex' : 'none';
      }
    </script>
  </body>
</html>